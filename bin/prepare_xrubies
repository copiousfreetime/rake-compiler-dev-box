#!/usr/bin/env bash

set -e

# Avoid running all the tasks over and over
mkdir -p "$HOME/.rake-compiler"
if [ -f "$HOME/.rake-compiler/.prepared" ]; then
  exit 0
fi

# shared directory between VM and host
cd '/vagrant'

source /usr/local/share/chruby/chruby.sh

# Build 1.9.3 using 2.2.0 as base
chruby 1.9.3
echo " ==== Building Ruby === "
ruby --version
gem install rake-compiler
rake-compiler cross-ruby VERSION=1.9.3-p551 HOST=i586-mingw32msvc

# Build 2.0.0 using 2.0.0
chruby 2.0.0
echo " ==== Building Ruby === "
ruby --version
gem install rake-compiler
rake-compiler cross-ruby VERSION=2.0.0-p598 HOST=i686-w64-mingw32   debugflags="-g"
rake-compiler cross-ruby VERSION=2.0.0-p598 HOST=x86_64-w64-mingw32 debugflags="-g"

# Build 2.1.5 using 2.1.5
chruby 2.1.5
echo " ==== Building Ruby === "
ruby --version
gem install rake-compiler
rake-compiler cross-ruby VERSION=2.1.5      HOST=i686-w64-mingw32 debugflags="-g"
rake-compiler cross-ruby VERSION=2.1.5      HOST=x86_64-w64-mingw32 debugflags="-g"

# Build 2.2.0 using 2.2.0
#chruby 2.2.0
#echo " ==== Building Ruby === "
#ruby --version
#gem install rake-compiler
#rake-compiler cross-ruby VERSION=2.2.0      HOST=i686-w64-mingw32 debugflags="-g"
#rake-compiler cross-ruby VERSION=2.2.0      HOST=x86_64-w64-mingw32 debugflags="-g"

# Mark installation prepared and don't run all this again
touch "$HOME/.rake-compiler/.prepared"
